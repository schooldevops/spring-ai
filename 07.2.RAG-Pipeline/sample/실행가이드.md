# ê°„ë‹¨í•œ RAG íŒŒì´í”„ë¼ì¸ êµ¬í˜„ ìƒ˜í”Œ í”„ë¡œì íŠ¸ ì‹¤í–‰ ê°€ì´ë“œ

ì´ ê°€ì´ë“œëŠ” 7.2.RAG-Pipeline ìƒ˜í”Œ í”„ë¡œì íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³  í…ŒìŠ¤íŠ¸í•˜ëŠ” ë°©ë²•ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.

## ğŸ“‹ ì‚¬ì „ ì¤€ë¹„ì‚¬í•­

- JDK 17 ì´ìƒ ì„¤ì¹˜
- OpenAI API Key ë°œê¸‰
- í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ê¶Œí•œ

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

**macOS / Linux:**
```bash
export OPENAI_API_KEY="sk-your-api-key-here"
```

**Windows (PowerShell):**
```powershell
$env:OPENAI_API_KEY="sk-your-api-key-here"
```

### 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰

```bash
./gradlew bootRun
```

ë˜ëŠ” IntelliJ IDEAì—ì„œ `RAGPipelineApplication.kt` ì‹¤í–‰

### 3. ì‹¤í–‰ í™•ì¸

ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë©”ì‹œì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤:

```
Started RAGPipelineApplication in X.XXX seconds
```

## ğŸ§ª API í…ŒìŠ¤íŠ¸

### 1. ìƒ˜í”Œ ë°ì´í„° ì´ˆê¸°í™”

```bash
curl -X POST http://localhost:8080/api/demo/init
```

**ì˜ˆìƒ ì‘ë‹µ:**
```json
{
  "status": "success",
  "message": "ìƒ˜í”Œ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.",
  "documentCount": 7
}
```

### 2. ê¸°ë³¸ RAG ì§ˆë¬¸ ë‹µë³€ (POST)

```bash
curl -X POST http://localhost:8080/api/rag/ask \
  -H "Content-Type: application/json" \
  -d '{
    "question": "í™˜ë¶ˆ ì •ì±…ì€ ë¬´ì—‡ì¸ê°€ìš”?",
    "topK": 3
  }'
```

**ì˜ˆìƒ ì‘ë‹µ:**
```json
{
  "question": "í™˜ë¶ˆ ì •ì±…ì€ ë¬´ì—‡ì¸ê°€ìš”?",
  "answer": "í™˜ë¶ˆ ì •ì±…ì— ë”°ë¥´ë©´ êµ¬ë§¤ í›„ 7ì¼ ì´ë‚´, ë¯¸ì‚¬ìš© ì œí’ˆì— í•œí•´ í™˜ë¶ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤...",
  "sources": [
    {
      "content": "í™˜ë¶ˆ ì •ì±…\n\nêµ¬ë§¤ í›„ 7ì¼ ì´ë‚´...",
      "metadata": {
        "title": "í™˜ë¶ˆ ì •ì±…",
        "source": "íšŒì‚¬ ì •ì±… ë¬¸ì„œ",
        "category": "policy"
      }
    }
  ],
  "context": "í™˜ë¶ˆ ì •ì±…\n\nêµ¬ë§¤ í›„ 7ì¼ ì´ë‚´..."
}
```

### 3. ê¸°ë³¸ RAG ì§ˆë¬¸ ë‹µë³€ (GET)

```bash
curl "http://localhost:8080/api/rag/ask?question=ë°°ì†¡%20ì •ì±…ì€%20ë¬´ì—‡ì¸ê°€ìš”?&topK=3"
```

### 4. êµ¬ì¡°í™”ëœ RAG ì§ˆë¬¸ ë‹µë³€

```bash
curl -X POST http://localhost:8080/api/rag/ask-structured \
  -H "Content-Type: application/json" \
  -d '{
    "question": "íšŒì› í˜œíƒì€ ë¬´ì—‡ì¸ê°€ìš”?",
    "topK": 3
  }'
```

### 5. ì—­í•  ê¸°ë°˜ RAG ì§ˆë¬¸ ë‹µë³€

```bash
curl -X POST http://localhost:8080/api/rag/ask-with-role \
  -H "Content-Type: application/json" \
  -d '{
    "question": "A/SëŠ” ì–´ë–»ê²Œ ë°›ë‚˜ìš”?",
    "role": "ê³ ê° ì§€ì› ë‹´ë‹¹ì",
    "tone": "ì¹œì ˆ",
    "topK": 3
  }'
```

### 6. ì¬ë­í‚¹ì„ í¬í•¨í•œ RAG

```bash
curl -X POST http://localhost:8080/api/rag/advanced/ask-with-reranking \
  -H "Content-Type: application/json" \
  -d '{
    "question": "ì£¼ë¬¸ ì·¨ì†ŒëŠ” ì–´ë–»ê²Œ í•˜ë‚˜ìš”?",
    "topK": 5,
    "finalK": 3
  }'
```

### 7. Context ê¸¸ì´ ì œí•œ RAG

```bash
curl -X POST http://localhost:8080/api/rag/advanced/ask-with-length-limit \
  -H "Content-Type: application/json" \
  -d '{
    "question": "ê²°ì œ ë°©ë²•ì€ ë¬´ì—‡ì¸ê°€ìš”?",
    "topK": 5,
    "maxLength": 2000
  }'
```

### 8. ì¹´í…Œê³ ë¦¬ í•„í„°ë§ RAG

```bash
curl -X POST http://localhost:8080/api/rag/advanced/ask-with-category \
  -H "Content-Type: application/json" \
  -d '{
    "question": "ì •ì±…ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”",
    "category": "policy",
    "topK": 3
  }'
```

### 9. ëŒ€í™” ì´ë ¥ì„ í¬í•¨í•œ RAG

```bash
# ì²« ë²ˆì§¸ ì§ˆë¬¸
curl -X POST http://localhost:8080/api/rag/conversation/ask \
  -H "Content-Type: application/json" \
  -d '{
    "question": "í™˜ë¶ˆ ì •ì±…ì€ ë¬´ì—‡ì¸ê°€ìš”?",
    "conversationId": "conv-123",
    "topK": 3
  }'

# ë‘ ë²ˆì§¸ ì§ˆë¬¸ (ì´ì „ ëŒ€í™” ì°¸ê³ )
curl -X POST http://localhost:8080/api/rag/conversation/ask \
  -H "Content-Type: application/json" \
  -d '{
    "question": "í™˜ë¶ˆ ê¸°ê°„ì€ ì–¼ë§ˆë‚˜ ë˜ë‚˜ìš”?",
    "conversationId": "conv-123",
    "topK": 3
  }'
```

### 10. ëŒ€í™” ì´ë ¥ ì¡°íšŒ

```bash
curl "http://localhost:8080/api/rag/conversation/history?conversationId=conv-123"
```

### 11. ëŒ€í™” ì´ë ¥ ì´ˆê¸°í™”

```bash
curl -X DELETE "http://localhost:8080/api/rag/conversation/history?conversationId=conv-123"
```

### 12. ë¬¸ì„œ ì¶”ê°€

```bash
curl -X POST http://localhost:8080/api/rag/documents \
  -H "Content-Type: application/json" \
  -d '{
    "text": "ìƒˆë¡œìš´ ì •ì±… ë‚´ìš©ì…ë‹ˆë‹¤.",
    "title": "ìƒˆ ì •ì±…",
    "source": "ì •ì±… ë¬¸ì„œ v3.0",
    "category": "policy"
  }'
```

## ğŸ” RAG íŒŒì´í”„ë¼ì¸ ë™ì‘ í™•ì¸

### 3ë‹¨ê³„ RAG íŒŒì´í”„ë¼ì¸

1. **Retrieval (ê²€ìƒ‰)**
   - `VectorStore.similaritySearch(question)` í˜¸ì¶œ
   - ê´€ë ¨ ë¬¸ì„œ ê²€ìƒ‰

2. **Augmentation (ì¦ê°•)**
   - ê²€ìƒ‰ëœ ë¬¸ì„œë¥¼ Context ë¬¸ìì—´ë¡œ ë³€í™˜
   - ë©”íƒ€ë°ì´í„° í¬í•¨/ì œì™¸ ì„ íƒ

3. **Generation (ìƒì„±)**
   - `PromptTemplate.create()`ë¡œ Contextì™€ ì§ˆë¬¸ ì£¼ì…
   - `ChatModel.call()`ë¡œ LLM í˜¸ì¶œ
   - ì‘ë‹µ ìƒì„±

### PromptTemplate ì‚¬ìš© í™•ì¸

```kotlin
// í…œí”Œë¦¿ ì •ì˜
private val ragTemplate = PromptTemplate("""
    ë‹¤ìŒ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì—¬ ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”:
    
    {context}
    
    ì§ˆë¬¸: {question}
""".trimIndent())

// ë³€ìˆ˜ ì£¼ì…
val prompt = ragTemplate.create(mapOf(
    "context" to context,
    "question" to question
))
```

## ğŸ’¡ í•™ìŠµ í™•ì¸

ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•´ë³´ì„¸ìš”:

1. **VectorStore.similaritySearch() ì‚¬ìš©**
   - ê´€ë ¨ ë¬¸ì„œ ê²€ìƒ‰ í™•ì¸
   - topKë¡œ ê²°ê³¼ ì œí•œ í™•ì¸

2. **Context ìƒì„±**
   - ë¬¸ì„œë¥¼ Contextë¡œ ë³€í™˜ í™•ì¸
   - ë©”íƒ€ë°ì´í„° í¬í•¨/ì œì™¸ í™•ì¸

3. **PromptTemplate ì‚¬ìš©**
   - ë™ì  í”„ë¡¬í”„íŠ¸ ìƒì„± í™•ì¸
   - Contextì™€ ì§ˆë¬¸ ì£¼ì… í™•ì¸

4. **ChatModel í˜¸ì¶œ**
   - Contextê°€ í¬í•¨ëœ í”„ë¡¬í”„íŠ¸ ì „ë‹¬ í™•ì¸
   - ì‘ë‹µ ì²˜ë¦¬ í™•ì¸

5. **ê³ ê¸‰ ê¸°ëŠ¥**
   - ì¬ë­í‚¹ ë™ì‘ í™•ì¸
   - Context ê¸¸ì´ ì œí•œ í™•ì¸
   - ì¹´í…Œê³ ë¦¬ í•„í„°ë§ í™•ì¸
   - ëŒ€í™” ì´ë ¥ ê´€ë¦¬ í™•ì¸

## âŒ ë¬¸ì œ í•´ê²°

### ë¬¸ì œ 1: ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŒ

**ì¦ìƒ:**
```
ì‘ë‹µì´ "ê´€ë ¨ ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"ë¡œ ë‚˜ì˜´
```

**í•´ê²°ì±…:**
1. ìƒ˜í”Œ ë°ì´í„° ì´ˆê¸°í™” í™•ì¸: `POST /api/demo/init`
2. ë¬¸ì„œ ì¶”ê°€ í™•ì¸: `POST /api/rag/documents`
3. ì§ˆë¬¸ í…ìŠ¤íŠ¸ í™•ì¸ (ìœ ì‚¬í•œ í‚¤ì›Œë“œ ì‚¬ìš©)

### ë¬¸ì œ 2: PromptTemplate ì˜¤ë¥˜

**ì¦ìƒ:**
```
Template variable not found
```

**í•´ê²°ì±…:**
1. í…œí”Œë¦¿ì˜ ë³€ìˆ˜ëª… í™•ì¸: `{context}`, `{question}`
2. `create()` ë©”ì„œë“œì˜ ë³€ìˆ˜ëª… í™•ì¸
3. ëª¨ë“  ë³€ìˆ˜ê°€ ì œê³µë˜ì—ˆëŠ”ì§€ í™•ì¸

### ë¬¸ì œ 3: Contextê°€ ë„ˆë¬´ ê¸¸ìŒ

**ì¦ìƒ:**
```
í† í° ì œí•œ ì˜¤ë¥˜
```

**í•´ê²°ì±…:**
1. topK ê°’ ê°ì†Œ
2. Context ê¸¸ì´ ì œí•œ ì‚¬ìš©: `POST /api/rag/advanced/ask-with-length-limit`
3. ë¬¸ì„œ ë‚´ìš© ìš”ì•½

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

ì‹¤í–‰ ì „ í™•ì¸ì‚¬í•­:

- [ ] JDK 17 ì´ìƒ ì„¤ì¹˜ë¨
- [ ] OpenAI API Key ë°œê¸‰ë¨
- [ ] í™˜ê²½ ë³€ìˆ˜ ì„¤ì •ë¨
- [ ] í”„ë¡œì íŠ¸ ë¹Œë“œ ì„±ê³µ (`./gradlew build`)
- [ ] ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì„±ê³µ (`./gradlew bootRun`)
- [ ] ìƒ˜í”Œ ë°ì´í„° ì´ˆê¸°í™” ì„±ê³µ (`POST /api/demo/init`)
- [ ] ê¸°ë³¸ RAG ì§ˆë¬¸ ë‹µë³€ ì„±ê³µ (`POST /api/rag/ask`)

## ğŸ“ í•™ìŠµ ê¶Œì¥ ìˆœì„œ

1. **ìƒ˜í”Œ ë°ì´í„° ì´ˆê¸°í™”**: `POST /api/demo/init`
2. **ê¸°ë³¸ RAG í…ŒìŠ¤íŠ¸**: `POST /api/rag/ask`
3. **êµ¬ì¡°í™”ëœ RAG í…ŒìŠ¤íŠ¸**: `POST /api/rag/ask-structured`
4. **ì—­í•  ê¸°ë°˜ RAG í…ŒìŠ¤íŠ¸**: `POST /api/rag/ask-with-role`
5. **ì¬ë­í‚¹ í…ŒìŠ¤íŠ¸**: `POST /api/rag/advanced/ask-with-reranking`
6. **ëŒ€í™” ì´ë ¥ í…ŒìŠ¤íŠ¸**: `POST /api/rag/conversation/ask`
7. **ì½”ë“œ ë¶„ì„**: PromptTemplateRAGService.kt í™•ì¸

## ğŸ“š í•µì‹¬ ê°œë… ì •ë¦¬

### RAG íŒŒì´í”„ë¼ì¸ 3ë‹¨ê³„

```kotlin
// 1. Retrieval: ë¬¸ì„œ ê²€ìƒ‰
val documents = vectorStore.similaritySearch(question) ?: emptyList()
val topK = documents.take(3)

// 2. Augmentation: Context ìƒì„±
val context = topK.joinToString("\n\n---\n\n") { it.text }

// 3. Generation: LLM í˜¸ì¶œ
val prompt = ragTemplate.create(mapOf(
    "context" to context,
    "question" to question
))
val response = chatModel.call(prompt)
val answer = response.results.firstOrNull()?.output?.text ?: ""
```

### PromptTemplate ì‚¬ìš©

```kotlin
// í…œí”Œë¦¿ ì •ì˜
private val ragTemplate = PromptTemplate("""
    ë¬¸ì„œ: {context}
    ì§ˆë¬¸: {question}
""".trimIndent())

// ë³€ìˆ˜ ì£¼ì…
val prompt = ragTemplate.create(mapOf(
    "context" to context,
    "question" to question
))
```

### Context ìƒì„± ë°©ë²•

```kotlin
// ê¸°ë³¸ Context
val context = documents.joinToString("\n\n") { it.text }

// ë©”íƒ€ë°ì´í„° í¬í•¨ Context
val context = documents.joinToString("\n\n---\n\n") { doc ->
    "[${doc.metadata["title"]}]\n${doc.text}"
}
```

---

**ë‹¤ìŒ í•™ìŠµ**: [8.1: ë¬¸ì„œ ë¡œë”© (Document Loaders)](../../README.md#81-ë¬¸ì„œ-ë¡œë”©-document-loaders)

