# PostgreSQL/PGVector ì—°ë™ ìƒ˜í”Œ í”„ë¡œì íŠ¸ ì‹¤í–‰ ê°€ì´ë“œ

ì´ ê°€ì´ë“œëŠ” 6.3.ConnectWithVectorDB ìƒ˜í”Œ í”„ë¡œì íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³  í…ŒìŠ¤íŠ¸í•˜ëŠ” ë°©ë²•ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.

## ğŸ“‹ ì‚¬ì „ ì¤€ë¹„ì‚¬í•­

- JDK 17 ì´ìƒ ì„¤ì¹˜
- Docker ë° Docker Compose ì„¤ì¹˜
- OpenAI API Key ë°œê¸‰
- í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ê¶Œí•œ

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### 1. Dockerë¡œ PostgreSQL/PGVector ì‹¤í–‰

```bash
# í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd 6.3.ConnectWithVectorDB/sample

# Docker Composeë¡œ PostgreSQL ì‹œì‘
docker-compose up -d

# ë¡œê·¸ í™•ì¸
docker-compose logs -f postgres
```

**ì˜ˆìƒ ì¶œë ¥:**
```
postgres_1  | PostgreSQL init process complete; ready for start up.
postgres_1  | database system is ready to accept connections
```

### 2. PGVector í™•ì¥ ìë™ í™œì„±í™” í™•ì¸

`init-scripts/01-init-pgvector.sql` íŒŒì¼ì´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ PGVector í™•ì¥ì´ í™œì„±í™”ë©ë‹ˆë‹¤.

í™•ì¥ì´ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸:

```bash
# PostgreSQL ì ‘ì†
docker exec -it spring-ai-postgres psql -U springai -d vectordb

# í™•ì¥ í™•ì¸
SELECT * FROM pg_extension WHERE extname = 'vector';

# ë²¡í„° íƒ€ì… í…ŒìŠ¤íŠ¸
SELECT '[1,2,3]'::vector;

# ì¢…ë£Œ
\q
```

**ì°¸ê³ **: í™•ì¥ì´ í™œì„±í™”ë˜ì§€ ì•Šì€ ê²½ìš°, `init-scripts/01-init-pgvector.sql` íŒŒì¼ì„ í™•ì¸í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ í™œì„±í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

### 3. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

**macOS / Linux:**
```bash
export OPENAI_API_KEY="sk-your-api-key-here"
```

**Windows (PowerShell):**
```powershell
$env:OPENAI_API_KEY="sk-your-api-key-here"
```

### 4. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰

```bash
./gradlew bootRun
```

ë˜ëŠ” IntelliJ IDEAì—ì„œ `PGVectorApplication.kt` ì‹¤í–‰

### 5. ì‹¤í–‰ í™•ì¸

ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë©”ì‹œì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤:

```
Started PGVectorApplication in X.XXX seconds
```

## ğŸ§ª API í…ŒìŠ¤íŠ¸

### ê¸°ë³¸ ë¬¸ì„œ ê´€ë¦¬

#### 1. ë¬¸ì„œ ì¶”ê°€

```bash
curl -X POST http://localhost:8080/api/documents/add \
  -H "Content-Type: application/json" \
  -d '{
    "text": "Spring AIëŠ” í”„ë ˆì„ì›Œí¬ì…ë‹ˆë‹¤.",
    "metadata": {"category": "framework"}
  }'
```

**ì˜ˆìƒ ì‘ë‹µ:**
```json
{
  "status": "success",
  "message": "ë¬¸ì„œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.",
  "documentId": "auto-generated",
  "text": "Spring AIëŠ” í”„ë ˆì„ì›Œí¬ì…ë‹ˆë‹¤.",
  "metadata": {
    "category": "framework"
  }
}
```

#### 2. ì—¬ëŸ¬ ë¬¸ì„œ ì¶”ê°€

```bash
curl -X POST http://localhost:8080/api/documents/batch/add \
  -H "Content-Type: application/json" \
  -d '{
    "texts": [
      "ì½”ë”©ì€ í”„ë¡œê·¸ë˜ë°ì˜ ì¼ë¶€ì…ë‹ˆë‹¤.",
      "ê°œë°œì€ ì†Œí”„íŠ¸ì›¨ì–´ë¥¼ ë§Œë“œëŠ” ê³¼ì •ì…ë‹ˆë‹¤.",
      "ìš”ë¦¬ëŠ” ìŒì‹ì„ ë§Œë“œëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤."
    ],
    "source": "manual"
  }'
```

#### 3. ìœ ì‚¬ë„ ê²€ìƒ‰ (POST)

```bash
curl -X POST http://localhost:8080/api/documents/search \
  -H "Content-Type: application/json" \
  -d '{
    "query": "í”„ë¡œê·¸ë˜ë°",
    "topK": 5
  }'
```

**ì˜ˆìƒ ì‘ë‹µ:**
```json
{
  "query": "í”„ë¡œê·¸ë˜ë°",
  "topK": 5,
  "resultCount": 2,
  "results": [
    {
      "rank": 1,
      "content": "ì½”ë”©ì€ í”„ë¡œê·¸ë˜ë°ì˜ ì¼ë¶€ì…ë‹ˆë‹¤.",
      "metadata": {
        "index": 0,
        "source": "manual",
        "addedAt": 1234567890
      },
      "id": "unknown"
    }
  ]
}
```

#### 4. ìœ ì‚¬ë„ ê²€ìƒ‰ (GET)

```bash
curl "http://localhost:8080/api/documents/search?query=í”„ë¡œê·¸ë˜ë°&topK=5"
```

### ì„œë¹„ìŠ¤ ê¸°ë°˜ ì‚¬ìš©

#### 5. ì„œë¹„ìŠ¤ë¥¼ í†µí•œ ë¬¸ì„œ ì¶”ê°€

```bash
curl -X POST http://localhost:8080/api/service/document/add \
  -H "Content-Type: application/json" \
  -d '{
    "text": "Kotlinì€ JVM ì–¸ì–´ì…ë‹ˆë‹¤.",
    "metadata": {"category": "programming", "language": "kotlin"}
  }'
```

#### 6. ì„œë¹„ìŠ¤ë¥¼ í†µí•œ ê²€ìƒ‰

```bash
curl -X POST http://localhost:8080/api/service/document/search \
  -H "Content-Type: application/json" \
  -d '{
    "query": "í”„ë¡œê·¸ë˜ë° ì–¸ì–´",
    "topK": 3
  }'
```

#### 7. ë©”íƒ€ë°ì´í„° í•„í„°ë§ ê²€ìƒ‰

```bash
curl -X POST http://localhost:8080/api/service/document/search-with-filter \
  -H "Content-Type: application/json" \
  -d '{
    "query": "í”„ë¡œê·¸ë˜ë°",
    "topK": 5,
    "category": "programming"
  }'
```

#### 8. ë¬¸ì„œ í†µê³„ ì¡°íšŒ

```bash
curl http://localhost:8080/api/service/document/stats
```

## ğŸ” PostgreSQL ë°ì´í„° í™•ì¸

### ë²¡í„° í…Œì´ë¸” í™•ì¸

```bash
# PostgreSQL ì ‘ì†
docker exec -it spring-ai-postgres psql -U springai -d vectordb

# í…Œì´ë¸” ëª©ë¡ í™•ì¸
\dt

# ë²¡í„° í…Œì´ë¸” ë°ì´í„° í™•ì¸ (PGVectorStoreê°€ ìƒì„±í•œ í…Œì´ë¸”)
SELECT * FROM vector_store LIMIT 5;

# ë²¡í„° ì°¨ì› í™•ì¸
SELECT array_length(embedding::float[], 1) as dimensions 
FROM vector_store 
LIMIT 1;
```

## âŒ ë¬¸ì œ í•´ê²°

### ë¬¸ì œ 1: Docker ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë˜ì§€ ì•ŠìŒ

**ì¦ìƒ:**
```
Error: Cannot connect to the Docker daemon
```

**í•´ê²°ì±…:**
1. Docker Desktop ì‹¤í–‰ í™•ì¸
2. Docker ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸: `docker ps`

### ë¬¸ì œ 2: PostgreSQL ì—°ê²° ì‹¤íŒ¨

**ì¦ìƒ:**
```
Connection refused: connect
```

**í•´ê²°ì±…:**
1. Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í™•ì¸: `docker-compose ps`
2. PostgreSQL í¬íŠ¸ í™•ì¸: `netstat -an | grep 5432`
3. application.ymlì˜ ë°ì´í„°ì†ŒìŠ¤ URL í™•ì¸

### ë¬¸ì œ 3: PGVector í™•ì¥ ì—†ìŒ

**ì¦ìƒ:**
```
ERROR: extension "vector" does not exist
```

**í•´ê²°ì±…:**
```sql
-- PostgreSQLì— ì ‘ì†í•˜ì—¬ í™•ì¥ í™œì„±í™”
CREATE EXTENSION IF NOT EXISTS vector;

-- í™•ì¥ í™•ì¸
SELECT * FROM pg_extension WHERE extname = 'vector';
```

### ë¬¸ì œ 4: PGVectorStore í´ë˜ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ

**ì¦ìƒ:**
```
Unresolved reference: PGVectorStore
```

**í•´ê²°ì±…:**
1. Spring AI ìµœì‹  ë¬¸ì„œ í™•ì¸: https://docs.spring.io/spring-ai/reference/api/vectordb/pgvector.html
2. ì •í™•í•œ íŒ¨í‚¤ì§€ëª… í™•ì¸
3. Spring AI ìµœì‹  ë²„ì „ ì‚¬ìš© ê³ ë ¤
4. í˜„ì¬ëŠ” SimpleVectorStoreë¥¼ ì‚¬ìš© (ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©)

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

ì‹¤í–‰ ì „ í™•ì¸ì‚¬í•­:

- [ ] JDK 17 ì´ìƒ ì„¤ì¹˜ë¨
- [ ] Docker ë° Docker Compose ì„¤ì¹˜ë¨
- [ ] Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ë¨ (`docker-compose ps`)
- [ ] PGVector í™•ì¥ í™œì„±í™”ë¨
- [ ] OpenAI API Key ë°œê¸‰ë¨
- [ ] í™˜ê²½ ë³€ìˆ˜ ì„¤ì •ë¨
- [ ] í”„ë¡œì íŠ¸ ë¹Œë“œ ì„±ê³µ (`./gradlew build`)
- [ ] ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì„±ê³µ (`./gradlew bootRun`)
- [ ] API ì—”ë“œí¬ì¸íŠ¸ ì‘ë‹µ í™•ì¸

## ğŸ“ í•™ìŠµ ê¶Œì¥ ìˆœì„œ

1. **Docker í™˜ê²½ ì„¤ì •**: `docker-compose up -d`
2. **PGVector í™•ì¥ í™œì„±í™”**: `CREATE EXTENSION vector;`
3. **ê¸°ë³¸ ë¬¸ì„œ ì¶”ê°€**: `/api/documents/add`
4. **ìœ ì‚¬ë„ ê²€ìƒ‰**: `/api/documents/search`
5. **ë°°ì¹˜ ë¬¸ì„œ ì¶”ê°€**: `/api/documents/batch/add`
6. **ì„œë¹„ìŠ¤ ê¸°ë°˜ ì‚¬ìš©**: `/api/service/document/*`
7. **PostgreSQL ë°ì´í„° í™•ì¸**: `psql` ì ‘ì†í•˜ì—¬ í…Œì´ë¸” í™•ì¸
8. **ì½”ë“œ ë¶„ì„**: PGVectorStoreConfig, DocumentService í™•ì¸

## ğŸ“š í•µì‹¬ ê°œë… ì •ë¦¬

### PostgreSQL/PGVector ì„¤ì • íŒ¨í„´

```yaml
# docker-compose.yml
services:
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: springai
      POSTGRES_PASSWORD: springai123
      POSTGRES_DB: vectordb
```

### PGVector í™•ì¥ í™œì„±í™”

```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

### DataSource ì„¤ì • íŒ¨í„´

```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/vectordb
    username: springai
    password: springai123
    driver-class-name: org.postgresql.Driver
```

### VectorStore ì„¤ì • íŒ¨í„´

```kotlin
@Configuration
class PGVectorStoreConfig(
    private val embeddingModel: EmbeddingModel,
    private val dataSource: DataSource
) {
    @Bean
    fun jdbcTemplate(): JdbcTemplate {
        return JdbcTemplate(dataSource)
    }
    
    @Bean
    fun pgVectorStore(jdbcTemplate: JdbcTemplate): VectorStore {
        return PgVectorStore.builder(jdbcTemplate, embeddingModel)
            .dimensions(1536)  // OpenAI text-embedding-ada-002
            .distanceType(PgVectorStore.PgDistanceType.COSINE_DISTANCE)
            .indexType(PgVectorStore.PgIndexType.HNSW)
            .removeExistingVectorStoreTable(false)
            .initializeSchema(true)
            .build()
    }
}
```

**ì¤‘ìš”**: PgVectorStore.BuilderëŠ” `JdbcTemplate`ê³¼ `EmbeddingModel`ì„ ë°›ìŠµë‹ˆë‹¤.

### ë¬¸ì„œ ì¶”ê°€ íŒ¨í„´

```kotlin
val document = Document("ë¬¸ì„œ ë‚´ìš©", metadata)
vectorStore.add(listOf(document))
```

### ìœ ì‚¬ë„ ê²€ìƒ‰ íŒ¨í„´

```kotlin
val results = vectorStore.similaritySearch(query) ?: emptyList()
val limitedResults = results.take(topK)
```

### ë¬¸ì„œ ì‚­ì œ íŒ¨í„´

```kotlin
vectorStore.delete(listOf(documentId))
```

---

**ë‹¤ìŒ í•™ìŠµ**: [7.1: RAG íŒ¨í„´ì˜ ì´í•´](../../README.md#71-rag-íŒ¨í„´ì˜-ì´í•´)

